# 系统整体架构与通信协议规范

## 1. 双端协同交互模型

本系统采用“大脑（ESP32）+ 小脑（STM32）”的非对称双核架构。为了应对网络断开或云端服务不可用的情况，系统设计了两种运行模式：

*   **本地模式 (Local Mode)**：默认上电状态。STM32 独立处理编码器、按键和手势传感器的输入，直接计算并输出 PWM 驱动灯光。此时 ESP32 仅作为旁观者接收状态上报。
*   **远程 UI 模式 (Remote UI Mode)**：当 ESP32 成功连接网络并接管系统时，可通过指令将 STM32 切换至此模式。此时，STM32 成为纯粹的“输入采集器”和“PWM 执行器”，所有物理交互事件（如转动旋钮）均透传给 ESP32，由 ESP32 结合云端逻辑计算后，再下发具体的灯光控制指令。

## 2. 物理接口规范

*   **通信介质**: UART (TTL 电平，需共地)
*   **引脚连接**:
    *   STM32 TX (PA9)  <--> ESP32 RX (GPIO 18)
    *   STM32 RX (PA10) <--> ESP32 TX (GPIO 17)
*   **通信参数**: `115200 bps`, 8 数据位, 无校验, 1 停止位 (8N1)
*   **帧格式**: `JSON 字符串` + `\r\n` (以换行符作为帧定界符)

## 3. 下行指令 (ESP32 -> STM32)

ESP32 作为主控，向下发出的控制指令。

### 3.1 灯光绝对控制
直接设置底层 PWM 占空比。
*   **格式**: `{"cmd":"light", "warm":500, "cold":500}`
*   **参数**: `warm` (暖光 0-1000), `cold` (冷光 0-1000)。0 为全灭，1000 为满载。

### 3.2 模式切换
*   **格式**: `{"cmd":"mode", "val":1}`
*   **参数**: `val` 为 `0` 表示进入 Local 模式，`1` 表示进入 Remote UI 模式。

## 4. 上行事件 (STM32 -> ESP32)

STM32 主动向上位机汇报的事件流。分为高频交互事件和低频状态事件。

### 4.1 交互事件 (实时透传)
| 事件源 | JSON 格式 | 字段说明 |
| :--- | :--- | :--- |
| **编码器** | `{"ev":"enc","diff":15}` | `diff`: 旋转增量。正数顺时针，负数逆时针。 |
| **按键动作** | `{"ev":"key","id":"ModeSW","act":"click"}` | `id`: 按键标识；`act`: 动作类型 (`click`, `double`, `triple`, `hold`, `release`)。 |
| **手势识别** | `{"ev":"gest","val":16}` | `val`: 手势特征码 (如 16 代表前推开灯)。 |

### 4.2 状态与环境 (周期/触发上报)
| 数据类型 | JSON 格式 | 触发条件 |
| :--- | :--- | :--- |
| **灯光状态** | `{"ev":"state","warm":500,"cold":500}` | 灯光参数发生变化且稳定 200ms 后触发（节流防抖）。 |
| **环境数据** | `{"ev":"env","t":25,"h":60,"l":80}` | 每 2 秒周期上报。`t`:温度, `h`:湿度, `l`:光照百分比。 |
| **心跳包** | `{"ev":"hb","up":120}` | 每 5 秒周期上报。`up`: 系统运行时长(秒)。 |
