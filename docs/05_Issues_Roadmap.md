# 已知缺陷与后续开发路线图

## 1. 延迟问题深度剖析 (Latency Analysis)

**现状**：目前从用户说完指令到灯光执行，平均延迟高达 **10秒**。
**耗时拆解分析**：
1.  **VAD 截断延迟 (~2.5s)**：系统需要等待 2.5 秒的持续静音才能确认用户说话完毕。
2.  **网络握手与 ASR 识别 (~2.0s)**：ESP32 将完整音频打包通过 HTTP POST 发送给百度 API，包含 TLS 握手和云端推理时间。
3.  **LLM 思考与工具调用 (~3.0s)**：DeepSeek 模型生成回复，并触发 `control_light` 工具。
4.  **TTS 语音合成与下载 (~2.5s)**：(假设后续接入 TTS) 文本转语音的生成与流式下载。

**优化方案 (Roadmap)**：
*   **流式 ASR**：废弃当前的 HTTP POST 录音文件模式，改用 WebSocket 流式传输，边录音边识别。
*   **缩短 VAD 阈值**：结合流式 ASR 的端点检测（VAD Endpoint），将静音等待时间缩短至 800ms。
*   **LLM 流式工具调用**：利用大模型的 SSE (Server-Sent Events) 流式输出，在解析到 JSON 工具调用的第一时间下发指令，而不必等待完整回复生成。

## 2. 通信可靠性升级方案

**现状**：STM32 与 ESP32 之间的 UART 仅使用 `\r\n` 分包，无校验。
**优化方案 (Roadmap)**：
*   引入 **COBS (Consistent Overhead Byte Stuffing)** 算法进行帧定界，彻底解决 JSON 字符串中可能包含控制字符导致的断帧问题。
*   在 JSON 负载外层增加 `CRC16` 校验字段。
*   实现简单的 `SEQ/ACK` 机制：ESP32 下发指令带 Sequence ID，STM32 执行后回复 ACK，超时 200ms 未收到 ACK 则重传（最多 3 次）。

## 3. 跨平台移植重构计划 (STM32 端)

为了偿还早期设计的技术债，计划对 STM32 端进行重构：
*   **引入轻量级事件总线**：在裸机系统中实现一个简单的 FIFO 队列，将中断中的事件（如 `Encoder_Get`）压入队列，在 `main` 循环中统一消费，解耦驱动与业务。
*   **构建 HAL 适配层**：将 `LED_SetWarm()` 等直接操作寄存器的函数，封装为 `HAL_PWM_SetDuty()`，为未来可能迁移到国产 RISC-V 芯片做准备。

## 4. 功能演进路线图 (To-Do List)

- [ ] **Phase 1: 性能优化**
  - [ ] 优化 VAD 算法，降低截断延迟。
  - [ ] 后端 Server 接入流式大模型 API。
- [ ] **Phase 2: 交互升级**
  - [ ] 在 ESP32 端移植 LVGL，点亮 LCD 屏幕。
  - [ ] 实现基于 LVGL 的天气、时间、灯光状态可视化 UI。
- [ ] **Phase 3: 稳定性加固**
  - [ ] 实现 UART 通信的 CRC 校验与重传机制。
  - [ ] 增加 ESP32 端的 OTA (Over-The-Air) 无线升级功能。
